<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" >
<meta name="viewport" content="width=device-width,initial-scale=1" >
<title>English Lesson Hub - CMS</title>
<style>
  :root {
    --primary:#0078d7;
    --primary-dark:#005fa3;
    --bg:#f4f4f4;
    --card:#fff;
    --text:#222;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;}
  header{background:var(--primary);color:#fff;padding:1.2rem;text-align:center;}
  header h1{margin:0;font-size:1.6rem}
  header p{margin:.2rem 0 0 0;opacity:.9}
  .wrap{max-width:900px;margin:1rem auto;padding:0 1rem}
  .container{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:1.5rem;margin-bottom:1rem}
  h2{margin:.2rem 0 1rem 0}
  input,textarea,select{width:100%;padding:.6rem .7rem;margin:.35rem 0;border:1px solid #d0d5dd;border-radius:8px;font-size:16px;box-sizing:border-box}
  button{background:var(--primary);color:#fff;border:none;padding:.6rem 1rem;border-radius:8px;cursor:pointer;font-weight:600;font-size:16px}
  button:hover{background:var(--primary-dark)}
  .btn-secondary{background:#555}
  .btn-secondary:hover{background:#444}
  .btn-success{background:#28a745}
  .btn-success:hover{background:#218838}
  .btn-danger{background:#dc3545}
  .btn-danger:hover{background:#c82333}
  .btn-warning{background:#ffc107;color:#000}
  .btn-warning:hover{background:#e0a800}
  .row{display:flex;gap:.5rem;flex-wrap:wrap}
  .row > *{flex:1;min-width:200px}
  .lesson{padding:1rem;border:1px solid #eee;border-radius:10px;margin:.7rem 0;text-align:left}
  .lesson h3{margin:.2rem 0;color:var(--primary)}
  .lesson.pending{background:#fff9e6;border-color:#ffc107}
  .lesson.approved{background:#e6f7e6;border-color:#28a745}
  nav a{text-decoration:none;background:var(--primary);color:#fff;padding:.35rem .7rem;border-radius:7px;margin:.2rem;display:inline-block}
  nav a:hover{background:var(--primary-dark)}
  #authMsg,#adminMsg{min-height:1.2em;color:#d11;margin-top:.5rem}
  .muted{color:#666;font-size:.9rem}
  .tab-nav{display:flex;gap:.5rem;margin-bottom:1rem;border-bottom:2px solid #eee}
  .tab-nav button{border-radius:8px 8px 0 0;background:transparent;color:var(--text);border-bottom:3px solid transparent}
  .tab-nav button.active{background:var(--primary);color:#fff;border-bottom-color:var(--primary)}
  .user-item{padding:.8rem;border:1px solid #ddd;border-radius:8px;margin:.5rem 0;display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap}
  .user-item.pending{background:#fff9e6}
  .user-item.approved{background:#e6f7e6}
  .badge{display:inline-block;padding:.2rem .5rem;border-radius:5px;font-size:.85rem;font-weight:600}
  .badge-pending{background:#ffc107;color:#000}
  .badge-approved{background:#28a745;color:#fff}

  /* Course-specific styles */
  .course-kids-english input,
  .course-kids-english textarea,
  .course-kids-english select{
    font-family:'Comic Neue','Comic Sans MS',cursive,sans-serif;
    background:#fdf6e3;
    border-color:#ffd34e;
  }
  .course-kids-english button{
    background:#ffd34e;
    color:#000;
    box-shadow:0 3px 0 #e0a800;
  }
  .course-kids-english button:hover{
    background:#ffe678;
  }

  .course-general-english input,
  .course-general-english textarea,
  .course-general-english select{
    font-family:'Comic Neue','Comic Sans MS',cursive,sans-serif;
    background:#f0f8ff;
    border-color:#a7dfff;
  }

  .course-speaking-pictures input,
  .course-speaking-pictures textarea,
  .course-speaking-pictures select{
    font-family:'Comic Neue','Comic Sans MS',cursive,sans-serif;
    background:#fff5f0;
    border-color:#ffb380;
  }

  .success-msg{color:#28a745;font-weight:600}
  .error-msg{color:#dc3545;font-weight:600}
</style>
</head>
<body>
<header>
  <h1>üåç English Lesson Hub - CMS</h1>
  <p>Content Management System</p>
</header>

<div class="wrap">
  <!-- USER AUTH -->
  <div class="container" id="userAuth">
    <div class="tab-nav">
      <button class="active" onclick="switchAuthTab('user')">User Login</button>
      <button onclick="switchAuthTab('admin')">Admin Login</button>
    </div>

    <div id="userAuthForm">
      <h2>User Login</h2>
      <div class="row">
        <input type="email" id="userEmail" placeholder="Email" >
        <input type="password" id="userPassword" placeholder="Password" >
      </div>
      <div class="row">
        <button id="userLoginBtn">Login</button>
        <button id="userRegisterBtn" class="btn-success">Register</button>
        <button id="userDemoBtn" class="btn-warning">Demo User</button>
      </div>
      <p id="authMsg"></p>
      <p class="muted">Register and wait for admin approval to access the CMS.</p>
    </div>

    <div id="adminAuthForm" style="display:none;">
      <h2>Admin Login</h2>
      <input type="text" id="adminUsername" placeholder="Username" >
      <input type="password" id="adminPassword" placeholder="Password" >
      <button id="adminLoginBtn">Login as Admin</button>
      <p id="adminMsg"></p>
      <p class="muted">Demo credentials - Username: admin, Password: admin123</p>
    </div>
  </div>

  <!-- USER DASHBOARD -->
  <div class="container" id="userDashboard" style="display:none;">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2 style="flex:auto">Welcome, <span id="displayUserEmail"></span></h2>
      <button id="userLogoutBtn" class="btn-secondary" style="flex:none">Logout</button>
    </div>
    <hr >

    <button id="toggleFormBtn">‚ûï New Lesson</button>
    <form id="lessonForm" style="display:none;margin-top:.6rem">
      <div class="row">
        <div style="flex:1">
          <label>Link to Course</label>
          <select id="lessonCourse" required>
            <option value="">-- Select Course --</option>
            <option value="kids-english">KIDS ENGLISH üçè</option>
            <option value="general-english">GENERAL ENGLISH ü¶ò</option>
            <option value="speaking-pictures">SPEAKING WITH PICTURES üñº</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Lesson Number</label>
          <input id="lessonOrder" type="number" placeholder="Lesson Number" required >
        </div>
      </div>
      <input id="lessonTitle" placeholder="Lesson Title (e.g., Lesson 1 ‚Äì Animals üê∂)" required >
      <textarea id="lessonBody" rows="5" placeholder="Each line: emoji + sentence" required></textarea>
      <button type="submit">Submit for Approval</button>
    </form>
    <div id="userLessonsList" style="margin-top:1rem">
      <h3>üìò My Lessons</h3>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div class="container" id="adminDashboard" style="display:none;">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2 style="flex:auto">Admin Dashboard</h2>
      <button id="adminLogoutBtn" class="btn-secondary" style="flex:none">Logout</button>
    </div>
    <hr >

    <div class="tab-nav">
      <button class="active" onclick="switchAdminTab('users')">User Management</button>
      <button onclick="switchAdminTab('lessons')">Lesson Approval</button>
      <button onclick="switchAdminTab('settings')">Settings</button>
    </div>

    <!-- User Management -->
    <div id="adminUsersTab">
      <h3>üë• User Management</h3>
      <div id="usersList"></div>
    </div>

    <!-- Lesson Approval -->
    <div id="adminLessonsTab" style="display:none;">
      <h3>üìö Lesson Approval</h3>
      <div id="lessonApprovalList"></div>
    </div>

    <!-- Settings -->
    <div id="adminSettingsTab" style="display:none;">
      <h3>‚öôÔ∏è Admin Settings</h3>
      <form id="changePasswordForm">
        <h4>Change Admin Password</h4>
        <input type="password" id="currentPassword" placeholder="Current Password" required >
        <input type="password" id="newPassword" placeholder="New Password" required >
        <input type="password" id="confirmPassword" placeholder="Confirm New Password" required >
        <button type="submit">Change Password</button>
        <p id="passwordMsg"></p>
      </form>
    </div>
  </div>

  <!-- PUBLIC VIEW -->
  <div class="container" id="public">
    <h2>üåè Approved Lessons Viewer</h2>
    <div>
      <label>Filter by Course:</label>
      <select id="courseFilter" style="max-width:300px;">
        <option value="">All Courses</option>
        <option value="kids-english">KIDS ENGLISH üçè</option>
        <option value="general-english">GENERAL ENGLISH ü¶ò</option>
        <option value="speaking-pictures">SPEAKING WITH PICTURES üñº</option>
      </select>
    </div>
    <div id="viewerList" style="margin-top:1rem"></div>
  </div>
</div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut,
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    getDoc,
    setDoc,
    updateDoc,
    deleteDoc,
    doc,
    query,
    where,
    orderBy,
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBx4To2-DIglfgq_eHve3bYXYKdsZ0sgEo",
    authDomain: "english-training-hub.firebaseapp.com",
    projectId: "english-training-hub",
    storageBucket: "english-training-hub.firebasestorage.app",
    messagingSenderId: "927072446139",
    appId: "1:927072446139:web:721de952b0e0b7aa19ab9e",
    measurementId: "G-34BBV99KXB",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI elements
  const userAuth = document.getElementById("userAuth");
  const userDashboard = document.getElementById("userDashboard");
  const adminDashboard = document.getElementById("adminDashboard");
  const lessonForm = document.getElementById("lessonForm");
  const authMsg = document.getElementById("authMsg");
  const adminMsg = document.getElementById("adminMsg");
  const passwordMsg = document.getElementById("passwordMsg");

  let currentUser = null;
  let isAdmin = false;

  // Custom modal functions
  function showNotification(message, type = 'success') {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
    modal.innerHTML = `
      <div style="background:white;padding:2rem;border-radius:12px;max-width:400px;text-align:center;">
        <h3 style="color:${type === 'success' ? '#28a745' : '#dc3545'};margin-top:0;">${type === 'success' ? '‚úì Success' : '‚úó Error'}</h3>
        <p style="color:#222;">${message}</p>
        <button class="btn-primary" onclick="this.closest('div[style*=fixed]').remove()" style="margin-top:1rem;">OK</button>
      </div>
    `;
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  // Initialize admin in Firestore if doesn't exist
  async function initializeAdmin() {
    const adminDocRef = doc(db, "admins", "admin");
    const adminDoc = await getDoc(adminDocRef);
    if (!adminDoc.exists()) {
      await setDoc(adminDocRef, {
        username: "admin",
        password: "admin123",
        createdAt: Date.now()
      });
    }
  }
  initializeAdmin();

  // Switch auth tab
  window.switchAuthTab = function(tab) {
    const userForm = document.getElementById("userAuthForm");
    const adminForm = document.getElementById("adminAuthForm");
    const tabs = document.querySelectorAll(".tab-nav button");

    tabs.forEach(t => t.classList.remove("active"));

    if (tab === "user") {
      userForm.style.display = "block";
      adminForm.style.display = "none";
      tabs[0].classList.add("active");
    } else {
      userForm.style.display = "none";
      adminForm.style.display = "block";
      tabs[1].classList.add("active");
    }
    authMsg.textContent = "";
    adminMsg.textContent = "";
  };

  // Switch admin tab
  window.switchAdminTab = function(tab) {
    const usersTab = document.getElementById("adminUsersTab");
    const lessonsTab = document.getElementById("adminLessonsTab");
    const settingsTab = document.getElementById("adminSettingsTab");
    const tabs = document.querySelectorAll("#adminDashboard .tab-nav button");

    tabs.forEach(t => t.classList.remove("active"));

    usersTab.style.display = "none";
    lessonsTab.style.display = "none";
    settingsTab.style.display = "none";

    if (tab === "users") {
      usersTab.style.display = "block";
      tabs[0].classList.add("active");
      loadUsers();
    } else if (tab === "lessons") {
      lessonsTab.style.display = "block";
      tabs[1].classList.add("active");
      loadLessonsForApproval();
    } else {
      settingsTab.style.display = "block";
      tabs[2].classList.add("active");
    }
  };

  // User Login
  document.getElementById("userLoginBtn").addEventListener("click", async () => {
    const email = document.getElementById("userEmail").value.trim();
    const pw = document.getElementById("userPassword").value.trim();
    if (!email || !pw) {
      authMsg.textContent = "Please enter email and password.";
      return;
    }
    authMsg.textContent = "";
    try {
      const userCred = await signInWithEmailAndPassword(auth, email, pw);
      // Check if approved
      const userDocRef = doc(db, "users", userCred.user.uid);
      const userDoc = await getDoc(userDocRef);
      if (!userDoc.exists() || !userDoc.data().approved) {
        authMsg.textContent = "Your account is pending admin approval.";
        await signOut(auth);
        return;
      }
    } catch (e) {
      authMsg.textContent = "Login failed: " + e.message;
    }
  });

  // User Register
  document.getElementById("userRegisterBtn").addEventListener("click", async () => {
    const email = document.getElementById("userEmail").value.trim();
    const pw = document.getElementById("userPassword").value.trim();
    if (!email || !pw) {
      authMsg.textContent = "Please enter email and password.";
      return;
    }
    authMsg.textContent = "";
    try {
      const userCred = await createUserWithEmailAndPassword(auth, email, pw);
      // Create user document with approved = false
      await setDoc(doc(db, "users", userCred.user.uid), {
        email: email,
        approved: false,
        createdAt: Date.now()
      });
      authMsg.className = "success-msg";
      authMsg.textContent = "Registration successful! Wait for admin approval.";
      await signOut(auth);
    } catch (e) {
      authMsg.className = "error-msg";
      authMsg.textContent = "Registration failed: " + e.message;
    }
  });

  // Demo User
  document.getElementById("userDemoBtn").addEventListener("click", async () => {
    const email = "demo@example.com";
    const password = "demopassword";
    authMsg.textContent = "";
    try {
      let userCred;
      try {
        userCred = await signInWithEmailAndPassword(auth, email, password);
      } catch {
        userCred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", userCred.user.uid), {
          email: email,
          approved: true,
          createdAt: Date.now()
        });
      }
      // Make sure demo user is approved
      const userDocRef = doc(db, "users", userCred.user.uid);
      const userDoc = await getDoc(userDocRef);
      if (!userDoc.exists()) {
        await setDoc(userDocRef, {
          email: email,
          approved: true,
          createdAt: Date.now()
        });
      } else if (!userDoc.data().approved) {
        await updateDoc(userDocRef, { approved: true });
      }
    } catch (e) {
      authMsg.textContent = "Demo login failed: " + e.message;
    }
  });

  // Admin Login
  document.getElementById("adminLoginBtn").addEventListener("click", async () => {
    const username = document.getElementById("adminUsername").value.trim();
    const password = document.getElementById("adminPassword").value.trim();

    if (username !== "admin") {
      adminMsg.textContent = "Invalid admin credentials.";
      return;
    }

    adminMsg.textContent = "";
    try {
      const adminDocRef = doc(db, "admins", "admin");
      const adminDoc = await getDoc(adminDocRef);

      if (!adminDoc.exists()) {
        adminMsg.textContent = "Admin account not found.";
        return;
      }

      if (adminDoc.data().password !== password) {
        adminMsg.textContent = "Invalid password.";
        return;
      }

      // Success
      isAdmin = true;
      userAuth.style.display = "none";
      adminDashboard.style.display = "block";
      loadUsers();
    } catch (e) {
      adminMsg.textContent = "Login error: " + e.message;
    }
  });

  // Change Password
  document.getElementById("changePasswordForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const current = document.getElementById("currentPassword").value;
    const newPass = document.getElementById("newPassword").value;
    const confirm = document.getElementById("confirmPassword").value;

    if (newPass !== confirm) {
      passwordMsg.className = "error-msg";
      passwordMsg.textContent = "New passwords don't match!";
      return;
    }

    if (newPass.length < 6) {
      passwordMsg.className = "error-msg";
      passwordMsg.textContent = "Password must be at least 6 characters.";
      return;
    }

    try {
      const adminDocRef = doc(db, "admins", "admin");
      const adminDoc = await getDoc(adminDocRef);

      if (adminDoc.data().password !== current) {
        passwordMsg.className = "error-msg";
        passwordMsg.textContent = "Current password is incorrect.";
        return;
      }

      await updateDoc(adminDocRef, { password: newPass });
      passwordMsg.className = "success-msg";
      passwordMsg.textContent = "Password changed successfully!";
      document.getElementById("changePasswordForm").reset();
    } catch (e) {
      passwordMsg.className = "error-msg";
      passwordMsg.textContent = "Error: " + e.message;
    }
  });

  // Logout
  document.getElementById("userLogoutBtn").addEventListener("click", () => {
    signOut(auth);
  });

  document.getElementById("adminLogoutBtn").addEventListener("click", () => {
    isAdmin = false;
    adminDashboard.style.display = "none";
    userAuth.style.display = "block";
    switchAuthTab('admin');
  });

  // Toggle lesson form
  document.getElementById("toggleFormBtn").addEventListener("click", () => {
    const form = document.getElementById("lessonForm");
    form.style.display = form.style.display === "block" ? "none" : "block";
  });

  // Change form style based on course selection
  document.getElementById("lessonCourse").addEventListener("change", (e) => {
    const form = document.getElementById("lessonForm");
    form.className = "";
    if (e.target.value) {
      form.className = `course-${e.target.value}`;
    }
  });

  // Submit lesson
  document.getElementById("lessonForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const course = document.getElementById("lessonCourse").value;
    const order = parseInt(document.getElementById("lessonOrder").value, 10);
    const title = document.getElementById("lessonTitle").value.trim();
    const content = document.getElementById("lessonBody").value.trim();

    if (!course || !Number.isFinite(order) || !title || !content) return;

    try {
      await addDoc(collection(db, "lessons"), {
        course: course,
        order: order,
        title: title,
        content: content,
        approved: false,
        createdBy: currentUser.email,
        createdAt: Date.now()
      });

      document.getElementById("lessonForm").reset();
      document.getElementById("lessonForm").style.display = "none";
      document.getElementById("lessonForm").className = "";
      await loadUserLessons();
      showNotification("Lesson submitted for admin approval!", "success");
    } catch (e) {
      showNotification("Error submitting lesson: " + e.message, "error");
    }
  });

  // Load user's lessons
  async function loadUserLessons() {
    const list = document.getElementById("userLessonsList");
    list.innerHTML = "<h3>üìò My Lessons</h3>";

    const q = query(
      collection(db, "lessons"),
      where("createdBy", "==", currentUser.email),
      orderBy("createdAt", "desc")
    );
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML += "<p class='muted'>No lessons yet. Create your first lesson!</p>";
      return;
    }

    snap.forEach((docSnap) => {
      const d = docSnap.data();
      const div = document.createElement("div");
      div.className = "lesson " + (d.approved ? "approved" : "pending");
      div.innerHTML = `
        <strong>#${d.order}</strong> ${d.title}
        <br/><small>Course: ${d.course}</small>
        <br/><span class="badge ${d.approved ? 'badge-approved' : 'badge-pending'}">
          ${d.approved ? 'Approved' : 'Pending Approval'}
        </span>
      `;
      list.appendChild(div);
    });
  }

  // Load users (admin)
  async function loadUsers() {
    const list = document.getElementById("usersList");
    list.innerHTML = "";

    const snap = await getDocs(collection(db, "users"));

    if (snap.empty) {
      list.innerHTML = "<p class='muted'>No users registered yet.</p>";
      return;
    }

    snap.forEach((docSnap) => {
      const u = docSnap.data();
      const div = document.createElement("div");
      div.className = "user-item " + (u.approved ? "approved" : "pending");
      div.innerHTML = `
        <div>
          <strong>${u.email}</strong>
          <span class="badge ${u.approved ? 'badge-approved' : 'badge-pending'}">
            ${u.approved ? 'Approved' : 'Pending'}
          </span>
        </div>
        <div class="row" style="flex:none;gap:.3rem;">
          ${!u.approved ? `<button class="btn-success" onclick="approveUser('${docSnap.id}')">Approve</button>` : ''}
          <button class="btn-danger" onclick="deleteUser('${docSnap.id}')">Delete</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  // Approve user
  window.approveUser = async function(userId) {
    try {
      await updateDoc(doc(db, "users", userId), { approved: true });
      loadUsers();
    } catch (e) {
      showNotification("Error approving user: " + e.message, "error");
    }
  };

  // Delete user
  window.deleteUser = async function(userId) {
    const confirmDiv = document.createElement('div');
    confirmDiv.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
    confirmDiv.innerHTML = `
      <div style="background:white;padding:2rem;border-radius:12px;max-width:400px;text-align:center;">
        <h3>Confirm Delete</h3>
        <p>Are you sure you want to delete this user?</p>
        <div style="display:flex;gap:1rem;justify-content:center;margin-top:1rem;">
          <button class="btn-secondary" onclick="this.closest('div[style*=fixed]').remove()">Cancel</button>
          <button class="btn-danger" onclick="confirmDeleteUser('${userId}')">Delete</button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  };

  window.confirmDeleteUser = async function(userId) {
    try {
      await deleteDoc(doc(db, "users", userId));
      document.querySelector('div[style*="position:fixed"]')?.remove();
      loadUsers();
    } catch (e) {
      showNotification("Error deleting user: " + e.message, "error");
    }
  };

  // Load lessons for approval (admin)
  async function loadLessonsForApproval() {
    const list = document.getElementById("lessonApprovalList");
    list.innerHTML = "";

    const snap = await getDocs(collection(db, "lessons"));

    if (snap.empty) {
      list.innerHTML = "<p class='muted'>No lessons submitted yet.</p>";
      return;
    }

    const lessons = [];
    snap.forEach((docSnap) => {
      lessons.push({ id: docSnap.id, ...docSnap.data() });
    });

    // Sort by approval status and date
    lessons.sort((a, b) => {
      if (a.approved === b.approved) return b.createdAt - a.createdAt;
      return a.approved ? 1 : -1;
    });

    lessons.forEach((lesson) => {
      const div = document.createElement("div");
      div.className = "lesson " + (lesson.approved ? "approved" : "pending");
      div.innerHTML = `
        <h3>${lesson.title}</h3>
        <p><strong>Course:</strong> ${lesson.course} | <strong>Order:</strong> #${lesson.order}</p>
        <p><strong>Created by:</strong> ${lesson.createdBy}</p>
        <p><strong>Content:</strong></p>
        <pre style="background:#f5f5f5;padding:.5rem;border-radius:5px;overflow-x:auto;">${lesson.content}</pre>
        <span class="badge ${lesson.approved ? 'badge-approved' : 'badge-pending'}">
          ${lesson.approved ? 'Approved' : 'Pending Approval'}
        </span>
        <div style="margin-top:.5rem;">
          ${!lesson.approved ? `<button class="btn-success" onclick="approveLesson('${lesson.id}')">Approve</button>` : ''}
          <button class="btn-danger" onclick="deleteLesson('${lesson.id}')">Delete</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  // Approve lesson
  window.approveLesson = async function(lessonId) {
    try {
      await updateDoc(doc(db, "lessons", lessonId), { approved: true });
      loadLessonsForApproval();
      loadPublic();
    } catch (e) {
      showNotification("Error approving lesson: " + e.message, "error");
    }
  };

  // Delete lesson
  window.deleteLesson = async function(lessonId) {
    const confirmDiv = document.createElement('div');
    confirmDiv.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
    confirmDiv.innerHTML = `
      <div style="background:white;padding:2rem;border-radius:12px;max-width:400px;text-align:center;">
        <h3>Confirm Delete</h3>
        <p>Are you sure you want to delete this lesson?</p>
        <div style="display:flex;gap:1rem;justify-content:center;margin-top:1rem;">
          <button class="btn-secondary" onclick="this.closest('div[style*=fixed]').remove()">Cancel</button>
          <button class="btn-danger" onclick="confirmDeleteLesson('${lessonId}')">Delete</button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  };

  window.confirmDeleteLesson = async function(lessonId) {
    try {
      await deleteDoc(doc(db, "lessons", lessonId));
      document.querySelector('div[style*="position:fixed"]')?.remove();
      loadLessonsForApproval();
      loadPublic();
    } catch (e) {
      showNotification("Error deleting lesson: " + e.message, "error");
    }
  };

  // Load public viewer (approved lessons only)
  async function loadPublic() {
    const viewer = document.getElementById("viewerList");
    const courseFilter = document.getElementById("courseFilter").value;

    viewer.innerHTML = "";

    let q;
    if (courseFilter) {
      q = query(
        collection(db, "lessons"),
        where("approved", "==", true),
        where("course", "==", courseFilter),
        orderBy("order", "asc")
      );
    } else {
      q = query(
        collection(db, "lessons"),
        where("approved", "==", true),
        orderBy("course", "asc")
      );
    }

    const snap = await getDocs(q);

    if (snap.empty) {
      viewer.innerHTML = "<p class='muted'>No approved lessons yet.</p>";
      return;
    }

    const lessons = snap.docs.map((x) => ({ id: x.id, ...x.data() }));

    // Group by course
    const grouped = {};
    lessons.forEach(l => {
      if (!grouped[l.course]) grouped[l.course] = [];
      grouped[l.course].push(l);
    });

    // Sort within each course
    Object.keys(grouped).forEach(course => {
      grouped[course].sort((a, b) => a.order - b.order);
    });

    // Display
    Object.keys(grouped).forEach(course => {
      const courseTitle = document.createElement("h3");
      courseTitle.textContent = course.toUpperCase().replace(/-/g, ' ');
      courseTitle.style.marginTop = "1.5rem";
      viewer.appendChild(courseTitle);

      grouped[course].forEach((l, i) => {
        const div = document.createElement("div");
        div.className = "lesson";
        div.id = `lesson${l.id}`;
        const lines = (l.content || "").split("\n").filter(Boolean);
        const contentHtml = lines.map(line => {
          const parts = line.split(" ");
          const emoji = parts[0] || "";
          const text = parts.slice(1).join(" ");
          return `<p>${emoji} ${text}</p>`;
        }).join("");

        div.innerHTML = `
          <h3>${l.title}</h3>
          <small>Course: ${l.course} | Lesson #${l.order}</small>
          ${contentHtml}
        `;
        viewer.appendChild(div);
      });
    });
  }

  // Course filter
  document.getElementById("courseFilter").addEventListener("change", loadPublic);

  // Auth state
  onAuthStateChanged(auth, async (user) => {
    if (user && !isAdmin) {
      const userDocRef = doc(db, "users", user.uid);
      const userDoc = await getDoc(userDocRef);

      if (!userDoc.exists() || !userDoc.data().approved) {
        userAuth.style.display = "block";
        userDashboard.style.display = "none";
        authMsg.textContent = "Your account is pending admin approval.";
        await signOut(auth);
        return;
      }

      currentUser = user;
      userAuth.style.display = "none";
      userDashboard.style.display = "block";
      adminDashboard.style.display = "none";
      document.getElementById("displayUserEmail").textContent = user.email || "";
      loadUserLessons();
    } else if (!isAdmin) {
      currentUser = null;
      userAuth.style.display = "block";
      userDashboard.style.display = "none";
      adminDashboard.style.display = "none";
    }
    loadPublic();
  });
</script>
</body>
</html>
