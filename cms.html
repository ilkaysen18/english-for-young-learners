<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Lessons CMS + Viewer</title>
<style>
  body{font-family:sans-serif;margin:0;background:#f4f4f4;text-align:center;}
  header{background:#0078d7;color:#fff;padding:1.3rem;}
  .container{max-width:650px;margin:1rem auto;background:#fff;padding:1rem;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
  input,textarea,select{width:100%;padding:.5rem;margin:.4rem 0;border:1px solid #ccc;border-radius:6px;}
  button{background:#0078d7;color:#fff;border:none;padding:.6rem 1.2rem;margin-top:.5rem;border-radius:5px;cursor:pointer;}
  button:hover{background:#005fa3;}
  .lesson{padding:1rem;margin:1rem 0;border-radius:8px;box-shadow:0 1px 5px rgba(0,0,0,.1);text-align:left;}
  .lesson h2{color:#0078d7;margin-top:0;}
  nav a{text-decoration:none;background:#0078d7;color:#fff;padding:.4rem .8rem;border-radius:5px;margin:.3rem;display:inline-block;}
  nav a:hover{background:#005fa3;}
  #authMsg{min-height:1.2em;}
</style>
</head>
<body>

<header>
  <h1>üåç English Lesson Hub</h1>
  <p>CMS (Admin) + Public Viewer</p>
</header>

<!-- AUTH -->
<div class="container" id="auth">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Login / Register</button>
  <p style="color:red;" id="authMsg"></p>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboard" style="display:none;">
  <h2>Welcome, <span id="userEmail"></span></h2>
  <button onclick="logout()" style="background:#555;">Logout</button>
  <hr />
  <button onclick="toggleForm()">‚ûï New Lesson</button>
  <form id="lessonForm" onsubmit="saveLesson(event)" style="display:none;">
    <input id="lessonOrder" type="number" placeholder="Lesson Number" required />
    <input id="lessonTitle" placeholder="Lesson Title (e.g., Lesson 1 ‚Äì Animals üê∂)" required />
    <textarea id="lessonBody" rows="5" placeholder="Each line: emoji + sentence" required></textarea>
    <button type="submit">Save Lesson</button>
  </form>
  <div id="lessonsList"><h3>üìò All Lessons</h3></div>
</div>

<!-- PUBLIC VIEW -->
<div class="container" id="public">
  <h2>üåè Course Viewer</h2>
  <div id="viewerList"></div>
</div>

<!-- Demo Login Button -->
<div class="container" style="margin-top:0.5rem;">
  <button id="demoBtn" style="background:#28a745;">Login as Demo User</button>
</div>

<script type="module">
  // Firebase modular v9+ imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut,
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    orderBy,
    query,
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  // Config
  const firebaseConfig = {
    apiKey: "AIzaSyBx4To2-DIglfgq_eHve3bYXYKdsZ0sgEo",
    authDomain: "english-training-hub.firebaseapp.com",
    projectId: "english-training-hub",
    storageBucket: "english-training-hub.firebasestorage.app",
    messagingSenderId: "927072446139",
    appId: "1:927072446139:web:721de952b0e0b7aa19ab9e",
    measurementId: "G-34BBV99KXB",
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  // Analytics will throw on non-secure origins; wrap just in case.
  try { getAnalytics(app); } catch (e) { /* no-op */ }

  // Initialize Auth and Firestore
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expose for inline handlers and other scripts
  window._fb = { auth, db, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, addDoc, collection, getDocs, orderBy, query };

  // UI refs
  const authDiv = document.getElementById("auth");
  const dash = document.getElementById("dashboard");
  const publicDiv = document.getElementById("public");
  const lessonForm = document.getElementById("lessonForm");
  const list = document.getElementById("lessonsList");
  const viewer = document.getElementById("viewerList");
  const userEmail = document.getElementById("userEmail");
  const authMsg = document.getElementById("authMsg");

  // Helper: show error
  function showAuthError(msg) {
    authMsg.textContent = msg || "";
    if (msg) setTimeout(() => (authMsg.textContent = ""), 4000);
  }

  // LOGIN / REGISTER
  window.login = async function () {
    const email = document.getElementById("email").value.trim();
    const pw = document.getElementById("password").value.trim();
    if (!email || !pw) { showAuthError("Enter email and password."); return; }
    try {
      await window._fb.signInWithEmailAndPassword(window._fb.auth, email, pw);
    } catch (e) {
      try {
        await window._fb.createUserWithEmailAndPassword(window._fb.auth, email, pw);
      } catch (e2) {
        showAuthError(e2.message || "Login failed.");
      }
    }
  };

  window.logout = () => window._fb.signOut(window._fb.auth).catch(() => {});

  window.toggleForm = () => {
    lessonForm.style.display = lessonForm.style.display === "block" ? "none" : "block";
  };

  // SAVE LESSON
  window.saveLesson = async (e) => {
    e.preventDefault();
    const order = parseInt(document.getElementById("lessonOrder").value, 10);
    const title = document.getElementById("lessonTitle").value.trim();
    const content = document.getElementById("lessonBody").value.trim();
    if (!Number.isFinite(order) || !title || !content) return;

    await window._fb.addDoc(window._fb.collection(window._fb.db, "lessons"), {
      order,
      title,
      content,
      timestamp: Date.now(),
    });

    lessonForm.reset();
    lessonForm.style.display = "none";
    await loadLessons();
    await loadPublic();
  };

  // LOAD ALL LESSONS FOR CMS
  async function loadLessons() {
    list.innerHTML = "<h3>üìò All Lessons</h3>";
    const q = window._fb.query(
      window._fb.collection(window._fb.db, "lessons"),
      window._fb.orderBy("order", "asc")
    );
    const snap = await window._fb.getDocs(q);
    snap.forEach((doc) => {
      const d = doc.data();
      list.innerHTML += `<div class="lesson"><strong>#${d.order}</strong> ${d.title}</div>`;
    });
  }

  // LOAD PUBLIC VIEWER
  async function loadPublic() {
    viewer.innerHTML = "";
    const q = window._fb.query(
      window._fb.collection(window._fb.db, "lessons"),
      window._fb.orderBy("order", "asc")
    );
    const snap = await window._fb.getDocs(q);
    const lessons = snap.docs.map((x) => x.data());
    lessons.forEach((l, i) => {
      const div = document.createElement("div");
      div.className = "lesson";
      const lines = (l.content || "").split("\n").filter(Boolean);
      const html = lines
        .map((line) => {
          const [emoji, ...words] = line.split(" ");
          return `<p>${emoji || ""} ${words.join(" ")}</p>`;
        })
        .join("");
      div.innerHTML = `
        <h2>${l.title}</h2>
        ${html}
        <nav>
          ${i > 0 ? `<a href="#lesson${lessons[i - 1].order}" onclick="scrollToLesson(${i - 1});return false;">‚Üê Previous</a>` : ""}
          <a href="#top" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">Back to Course</a>
          ${i < lessons.length - 1 ? `<a href="#lesson${lessons[i + 1].order}" onclick="scrollToLesson(${i + 1});return false;">Next ‚Üí</a>` : ""}
        </nav>
      `;
      div.id = `lesson${l.order}`;
      viewer.appendChild(div);
    });
  }

  window.scrollToLesson = (i) => {
    const els = document.getElementsByClassName("lesson");
    if (els[i]) els[i].scrollIntoView({ behavior: "smooth" });
  };

  // AUTH STATE
  window._fb.onAuthStateChanged(window._fb.auth, (user) => {
    if (user) {
      authDiv.style.display = "none";
      dash.style.display = "block";
      userEmail.textContent = user.email || "";
      loadLessons();
    } else {
      authDiv.style.display = "block";
      dash.style.display = "none";
    }
    loadPublic();
  });

  // Demo button inside same module (so it can access the imported functions)
  document.getElementById("demoBtn").addEventListener("click", async () => {
    const email = "demo@example.com";
    const password = "demopassword";
    try {
      await window._fb.signInWithEmailAndPassword(window._fb.auth, email, password);
    } catch {
      try {
        await window._fb.createUserWithEmailAndPassword(window._fb.auth, email, password);
      } catch (e) {
        showAuthError(e.message || "Demo login failed.");
      }
    }
  });
</script>
</body>
</html>
