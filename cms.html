<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Lesson Hub</title>
<style>
  :root {
    --primary:#0078d7;
    --primary-dark:#005fa3;
    --bg:#f4f4f4;
    --card:#fff;
    --text:#222;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;}
  header{background:var(--primary);color:#fff;padding:1.2rem;text-align:center;}
  header h1{margin:0;font-size:1.6rem}
  header p{margin:.2rem 0 0 0;opacity:.9}
  .wrap{max-width:780px;margin:1rem auto;padding:0 1rem}
  .container{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:1rem;margin-bottom:1rem}
  h2{margin:.2rem 0 1rem 0}
  input,textarea,select{width:100%;padding:.6rem .7rem;margin:.35rem 0;border:1px solid #d0d5dd;border-radius:8px;font-size:1rem}
  button{background:var(--primary);color:#fff;border:none;padding:.6rem 1rem;border-radius:8px;cursor:pointer;font-weight:600}
  button:hover{background:var(--primary-dark)}
  .btn-secondary{background:#555}
  .btn-secondary:hover{background:#444}
  .btn-success{background:#28a745}
  .btn-success:hover{background:#218838}
  .row{display:flex;gap:.5rem;flex-wrap:wrap}
  .row > *{flex:1}
  .lesson{padding:1rem;border:1px solid #eee;border-radius:10px;margin:.7rem 0;text-align:left}
  .lesson h3{margin:.2rem 0;color:var(--primary)}
  nav a{text-decoration:none;background:var(--primary);color:#fff;padding:.35rem .7rem;border-radius:7px;margin:.2rem;display:inline-block}
  nav a:hover{background:var(--primary-dark)}
  #authMsg{min-height:1.2em;color:#d11}
  .muted{color:#666;font-size:.9rem}
</style>
</head>
<body>
<header>
  <h1>üåç English Lesson Hub</h1>
  <p>Simple CMS + Public Viewer</p>
</header>

<div class="wrap">
  <!-- AUTH -->
  <div class="container" id="auth">
    <h2>Login</h2>
    <div class="row">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
    </div>
    <div class="row">
      <button id="loginBtn">Login / Register</button>
      <button id="demoBtn" class="btn-success">Login as Demo User</button>
    </div>
    <p id="authMsg"></p>
    <p class="muted">First time? Enter an email and password, then press Login / Register.</p>
  </div>

  <!-- DASHBOARD -->
  <div class="container" id="dashboard" style="display:none;">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2 style="flex:auto">Welcome, <span id="userEmail"></span></h2>
      <button id="logoutBtn" class="btn-secondary" style="flex:none">Logout</button>
    </div>
    <hr />
    <button id="toggleFormBtn">‚ûï New Lesson</button>
    <form id="lessonForm" style="display:none;margin-top:.6rem">
      <div class="row">
        <input id="lessonOrder" type="number" placeholder="Lesson Number" required />
      </div>
      <input id="lessonTitle" placeholder="Lesson Title (e.g., Lesson 1 ‚Äì Animals üê∂)" required />
      <textarea id="lessonBody" rows="5" placeholder="Each line: emoji + sentence" required></textarea>
      <button type="submit">Save Lesson</button>
    </form>
    <div id="lessonsList" style="margin-top:1rem"><h3>üìò All Lessons</h3></div>
  </div>

  <!-- PUBLIC VIEW -->
  <div class="container" id="public">
    <h2>üåè Course Viewer</h2>
    <div id="viewerList"></div>
  </div>
</div>

<script type="module">
  // Firebase modular v9+ imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut,
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    orderBy,
    query,
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  // Config (replace with your own if different)
  const firebaseConfig = {
    apiKey: "AIzaSyBx4To2-DIglfgq_eHve3bYXYKdsZ0sgEo",
    authDomain: "english-training-hub.firebaseapp.com",
    projectId: "english-training-hub",
    storageBucket: "english-training-hub.firebasestorage.app",
    messagingSenderId: "927072446139",
    appId: "1:927072446139:web:721de952b0e0b7aa19ab9e",
    measurementId: "G-34BBV99KXB",
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch (_) {}

  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI elements
  const authDiv = document.getElementById("auth");
  const dash = document.getElementById("dashboard");
  const lessonForm = document.getElementById("lessonForm");
  const list = document.getElementById("lessonsList");
  const viewer = document.getElementById("viewerList");
  const userEmail = document.getElementById("userEmail");
  const authMsg = document.getElementById("authMsg");

  const loginBtn = document.getElementById("loginBtn");
  const demoBtn = document.getElementById("demoBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const toggleFormBtn = document.getElementById("toggleFormBtn");

  function setAuthMsg(msg) {
    authMsg.textContent = msg || "";
  }

  // Auth handlers
  loginBtn.addEventListener("click", async () => {
    const email = document.getElementById("email").value.trim();
    const pw = document.getElementById("password").value.trim();
    if (!email || !pw) {
      setAuthMsg("Please enter email and password.");
      return;
    }
    setAuthMsg("");
    try {
      await signInWithEmailAndPassword(auth, email, pw);
    } catch (e) {
      try {
        await createUserWithEmailAndPassword(auth, email, pw);
      } catch (e2) {
        setAuthMsg(e2.message || "Login failed.");
      }
    }
  });

  demoBtn.addEventListener("click", async () => {
    const email = "demo@example.com";
    const password = "demopassword";
    setAuthMsg("");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch {
      try {
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (e) {
        setAuthMsg(e.message || "Demo login failed.");
      }
    }
  });

  logoutBtn?.addEventListener("click", () => {
    signOut(auth).catch(()=>{});
  });

  toggleFormBtn.addEventListener("click", () => {
    lessonForm.style.display = lessonForm.style.display === "block" ? "none" : "block";
  });

  // Save lesson
  lessonForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const order = parseInt(document.getElementById("lessonOrder").value, 10);
    const title = document.getElementById("lessonTitle").value.trim();
    const content = document.getElementById("lessonBody").value.trim();
    if (!Number.isFinite(order) || !title || !content) return;
    await addDoc(collection(db, "lessons"), { order, title, content, timestamp: Date.now() });
    lessonForm.reset();
    lessonForm.style.display = "none";
    await loadLessons();
    await loadPublic();
  });

  // Load lessons for CMS
  async function loadLessons() {
    if (!list) return;
    list.innerHTML = "<h3>üìò All Lessons</h3>";
    const q = query(collection(db, "lessons"), orderBy("order", "asc"));
    const snap = await getDocs(q);
    snap.forEach((doc) => {
      const d = doc.data();
      const div = document.createElement("div");
      div.className = "lesson";
      div.innerHTML = `<strong>#${d.order}</strong> ${d.title}`;
      list.appendChild(div);
    });
  }

  // Load public viewer
  async function loadPublic() {
    if (!viewer) return;
    viewer.innerHTML = "";
    const q = query(collection(db, "lessons"), orderBy("order", "asc"));
    const snap = await getDocs(q);
    const lessons = snap.docs.map((x) => x.data());

    lessons.forEach((l, i) => {
      const div = document.createElement("div");
      div.className = "lesson";
      div.id = `lesson${l.order}`;
      const lines = (l.content || "").split("\n").filter(Boolean);
      const contentHtml = lines.map(line => {
        const [emoji, ...words] = line.split(" ");
        return `<p>${emoji || ""} ${words.join(" ")}</p>`;
      }).join("");

      div.innerHTML = `
        <h3>${l.title}</h3>
        ${contentHtml}
        <nav>
          ${i>0 ? `<a href="#lesson${lessons[i-1].order}" data-go="${i-1}">‚Üê Previous</a>` : ""}
          <a href="#top" data-top>Back to Course</a>
          ${i<lessons.length-1 ? `<a href="#lesson${lessons[i+1].order}" data-go="${i+1}">Next ‚Üí</a>` : ""}
        </nav>
      `;
      viewer.appendChild(div);
    });

    // Smooth navigation
    viewer.querySelectorAll('a[data-go]').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const idx = parseInt(a.getAttribute('data-go'), 10);
        const target = viewer.getElementsByClassName('lesson')[idx];
        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });
    viewer.querySelectorAll('a[data-top]').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  }

  // Auth state
  onAuthStateChanged(auth, (user) => {
    if (user) {
      authDiv.style.display = "none";
      dash.style.display = "block";
      userEmail.textContent = user.email || "";
      loadLessons();
    } else {
      authDiv.style.display = "block";
      dash.style.display = "none";
    }
    loadPublic();
  });
</script>
</body>
</html>
