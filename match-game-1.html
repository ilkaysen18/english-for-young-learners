<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- Prevent zooming -->
<meta name="viewport" content="width=device-width, initial-scale=1.0,
maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<title>Animal Emoji Match‚Äë3+ Game (12√ó16)</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    touch-action: none; /* blocks pinch / double tap zoom */
    -ms-touch-action: none;
  }
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg, #fefcea, #f1da36);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    text-align: center;
  }
  h1 {
    color: #444;
    margin: 12px 0 8px;
    font-size: clamp(28px, 5vw, 36px);
  }
  #status {
    font-size: clamp(20px, 3.5vw, 28px);
    font-weight: bold;
    margin: 5px 0;
  }
  #gameContainer {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
  }
  #gameBoard {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    aspect-ratio: 12 / 16;
    width: 95vw;
    max-height: 80vh;
    grid-gap: 0.6vw;
  }
  .tile {
    background: #fff;
    border-radius: 0.5vw;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(20px, 3.8vw, 40px);
    cursor: pointer;
    user-select: none;
    transition: transform 0.2s, background 0.25s;
  }
  .tile.selected { background: #b8ffba; transform: scale(1.12); }
  #message {
    font-size: clamp(22px, 4vw, 32px);
    font-weight: bold;
    color: #3b7a00;
    min-height: 3vh;
    margin-top: 0.8vh;
  }
  button {
    background: #4caf50;
    color: white;
    border: none;
    padding: 1vw 3vw;
    font-size: clamp(22px, 4vw, 30px);
    border-radius: 1vw;
    cursor: pointer;
    margin-top: 1.5vh;
  }
  button:hover { background: #45a049; }

  @keyframes fall {
    from { transform: translateY(-2vh); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
</style>
</head>
<body>
<header>
  <h3 style="font-family:'Poppins',sans-serif; color:#0066cc; margin:4px 0; letter-spacing:1px;">
    English Training Hub
  </h3>
  <h1 style="font-family:'Fredoka One',cursive; color:#ff6600; margin:6px 0; text-shadow:1px 1px 2px #999;">
    Emoji Crush üéâ
  </h1>
  <h2 style="color:#333; font-weight:600; margin-top:4px;">
    üêæ Match 3+ Animal Emojis!
  </h2>
</header>
</p>
<h2>üêæ Match‚ÄØ3+‚ÄØAnimal‚ÄØEmojis!</h2>
<div id="status">Score:‚ÄØ0‚ÄØ|‚ÄØLevel:‚ÄØ1‚ÄØ|‚ÄØTarget:‚ÄØ100</div>
<div id="gameContainer"><div id="gameBoard"></div></div>
<div id="message"></div>
<button id="restart">Restart</button>

<script>
  // === CONFIGURATION ===
  const rows = 16;
  const cols = 12;
  const animals = ['üêº','üê∏','üê∑','ü¶ò','üêí'];
  let board = [];
  let selected = [];
  let score = 0;
  let level = 1;
  const baseTarget = 100;

  const gameBoard = document.getElementById('gameBoard');
  const statusDisplay = document.getElementById('status');
  const messageDisplay = document.getElementById('message');

  // === SOUND SYSTEM ===
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playTone(f, d=0.15, type='sine', vol=0.2){
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = f;
    g.gain.value = vol;
    osc.connect(g);
    g.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + d);
  }
  function successSound(){ [440,660,880].forEach((f,i)=>setTimeout(()=>playTone(f,0.15),i*150)); }
  function failSound(){ [200,150].forEach((f,i)=>setTimeout(()=>playTone(f,0.2,'square'),i*250)); }
  function victorySound(){ [523,659,784,1046].forEach((f,i)=>setTimeout(()=>playTone(f,0.2,'triangle',0.25),i*200)); }
  function shuffleSound(){ [220,330,440].forEach((f,i)=>setTimeout(()=>playTone(f,0.1,'sine',0.15),i*120)); }

  // === BOARD INIT ===
  function initBoard(){
    createRandomBoard();
    ensurePlayableBoard();
    renderBoard();
    updateStatus();
    messageDisplay.textContent = '';
  }

  function createRandomBoard(){
    board = [];
    for(let r=0;r<rows;r++){
      const row=[];
      for(let c=0;c<cols;c++){
        row.push(animals[Math.floor(Math.random()*animals.length)]);
      }
      board.push(row);
    }
  }

  function ensurePlayableBoard(){
    let safety = 0;
    while(!hasPossibleMoves() && safety < 100){
      shuffleBoard();
      safety++;
    }
  }

  function renderBoard(){
    gameBoard.innerHTML = '';
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const tile=document.createElement('div');
        tile.className='tile';
        tile.textContent=board[r][c];
        tile.dataset.row=r;
        tile.dataset.col=c;
        tile.addEventListener('click',tileClick);
        gameBoard.appendChild(tile);
      }
    }
  }

  // === MATCH DETECTION ===
function findMatchLine(sel) {
  if (sel.length < 3) return null;
  const e = sel[0].emoji;
  if (!sel.every(s => s.emoji === e)) return null;

  // Sort for consistency
  const rs = sel.map(s => s.r);
  const cs = sel.map(s => s.c);

  // Check straight line (horizontal, vertical, diagonal)
  const dr = rs[1] - rs[0];
  const dc = cs[1] - cs[0];
  const straight = sel.every((s, i, arr) =>
    i === 0 || (s.r - arr[i - 1].r === dr && s.c - arr[i - 1].c === dc)
  );
  if (straight) return 'line';

  // Check 2√ó2 or clustered block
  const minR = Math.min(...rs);
  const maxR = Math.max(...rs);
  const minC = Math.min(...cs);
  const maxC = Math.max(...cs);
  if ((maxR - minR <= 1) && (maxC - minC <= 1)) return 'block';

  // Check loose diagonal (slant)
  const sameSlope = Math.abs((rs[rs.length - 1] - rs[0]) / (cs[cs.length - 1] - cs[0])) === 1;
  if (sameSlope) return 'diagonal';

  return null;
}

  function calculatePoints(n){
    if(n===3) return 10;
    if(n===4) return 20;
    if(n===5) return 35;
    return 35+(n-5)*20;
  }

  // === TILE SELECTING ===
  function tileClick(e){
    const tile=e.currentTarget;
    const r=+tile.dataset.row, c=+tile.dataset.col;
    if(tile.classList.contains('selected')) return;
    tile.classList.add('selected');
    selected.push({r,c,emoji:board[r][c],tile});
    if (selected.length >= 3) {
  const dir = findMatchLine(selected);
  if (dir) {
    // Wait a few seconds before confirming match ‚Äî allow more selection
    clearTimeout(window.matchTimeout);
    window.matchTimeout = setTimeout(() => {
      // After delay, finalize the match with however many were selected
      const pts = calculatePoints(selected.length);
      successSound();
      score += pts;
      messageDisplay.textContent = `Matched ${selected.length} for +${pts} üéâ`;
      selected.forEach(s => {
        board[s.r][s.c] = null;
        s.tile.style.visibility = 'hidden';
      });
      updateStatus();
      selected = [];
      setTimeout(fallDown, 400);
    }, 500); // 0.5-second delay (adjust as desired) 
  }
    }
    if(selected.length>=7 && !findMatchLine(selected)){
      failSound();
      selected.forEach(s=>s.tile.classList.remove('selected'));
      selected=[];
    }
  }

  // === GRAVITY / FALL ===
  function fallDown(){
    for(let c=0;c<cols;c++){
      let write=rows-1;
      for(let r=rows-1;r>=0;r--){
        if(board[r][c]!==null){
          board[write][c]=board[r][c];
          if(write!==r) board[r][c]=null;
          write--;
        }
      }
      for(let r=write;r>=0;r--) board[r][c]=animals[Math.floor(Math.random()*animals.length)];
    }
    renderFall();
    autoShuffleIfNoMoves();
    checkLevelComplete();
  }

  function renderFall(){
    gameBoard.innerHTML='';
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const tile=document.createElement('div');
        tile.className='tile';
        tile.textContent=board[r][c];
        tile.style.animation='fall 0.4s ease';
        tile.dataset.row=r; tile.dataset.col=c;
        tile.addEventListener('click',tileClick);
        gameBoard.appendChild(tile);
      }
    }
  }

  // === MOVE VALIDATION ===
  function hasPossibleMoves(){
    // Checks if any 3-in-a-row (horizontal or vertical) already exists on the board.
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const e=board[r][c];
        if(e == null) continue;
        // Horizontal 3+
        if(c+2<cols && board[r][c+1]===e && board[r][c+2]===e) return true;
        // Vertical 3+
        if(r+2<rows && board[r+1][c]===e && board[r+2][c]===e) return true;
      }
    }
    return false;
  }

  function shuffleBoard(){
    const flat=board.flat();
    for(let i=flat.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [flat[i],flat[j]]=[flat[j],flat[i]];
    }
    board=[];
    for(let r=0;r<rows;r++) board.push(flat.slice(r*cols,(r+1)*cols));
  }

  // === AUTO SHUFFLE ===
  function autoShuffleIfNoMoves(){
    if(!hasPossibleMoves()){
      shuffleSound();
      messageDisplay.textContent='üîÑ No matches available ‚Äî Shuffling...';
      shuffleBoard();
      ensurePlayableBoard();
      setTimeout(()=>{ renderFall(); messageDisplay.textContent=''; },500);
    }
  }

  // === LEVEL SYSTEM ===
  function checkLevelComplete(){
    const target=baseTarget*level;
    if(score>=target){
      victorySound();
      messageDisplay.textContent=`üéâ You cleared Level ${level}! ü•≥`;
      const btn=document.createElement('button');
      btn.textContent='Next Level ‚ñ∂Ô∏è';
      btn.onclick=()=>{
        level++;
        messageDisplay.textContent='';
        initBoard();
      };
      messageDisplay.appendChild(btn);
    }
  }

  function updateStatus(){
    const target=baseTarget*level;
    statusDisplay.textContent=`Score: ${score} | Level: ${level} | Target: ${target}`;
  }

  document.getElementById('restart').addEventListener('click',()=>{
    score=0; level=1;
    initBoard();
  });

  initBoard();
</script>
</body>
</html>
