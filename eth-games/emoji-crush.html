<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emoji Crush Adventure</title>
<style>
  body {
    font-family: "Segoe UI Emoji", sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(to bottom, #f0f8ff, #cce7ff);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    flex-direction: column;
  }
  #map, #game, #login {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }
  h1, h2 { margin: 0; }
  #gameBoard {
    display: grid;
    grid-template-columns: repeat(8, 60px);
    grid-template-rows: repeat(8, 60px);
    gap: 5px;
  }
  .tile {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 30px;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    transition: transform 0.3s, background 0.3s;
    user-select: none;
  }
  .tile.selected { background: #a3f7a3; border: 2px solid #2ecc71; }
  .level-tile {
    font-size: 36px;
    cursor: pointer;
    background: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    text-align: center;
    line-height: 60px;
    position: absolute;
    transition: transform 0.3s, opacity 0.3s, box-shadow 0.3s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .locked { opacity: 0.3; cursor: not-allowed; }
  .unlocked { animation: bounce 1s infinite alternate; box-shadow: 0 0 15px #ffd700; }
  @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
  button {
    padding: 10px 20px;
    border: none;
    background: #4caf50;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover { background: #45a049; }
  #message { font-weight: bold; color: #3b7a00; }
</style>
</head>
<body>

<!-- üîë Login -->
<div id="login">
  <h1>Login to Play</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="loginBtn">Login / Signup</button>
  <div id="loginMessage"></div>
</div>

<!-- üåç Map -->
<div id="map">
  <h1>üåç Emoji Adventure Map</h1>
  <div style="position: relative; width: 400px; height: 500px;" id="mapGrid"></div>
</div>

<!-- üéÆ Game -->
<div id="game">
  <h2 id="levelTitle">Level</h2>
  <div id="gameBoard"></div>
  <div id="message"></div>
  <button id="backToMap">üè† Back to Map</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-firestore-compat.js"></script>

<script>
  // === Firebase Setup ===
  const firebaseConfig = {
    apiKey: "AIzaSyBx4To2-DIglfgq_eHve3bYXYKdsZ0sgEo",
    authDomain: "english-training-hub.firebaseapp.com",
    projectId: "english-training-hub",
    storageBucket: "english-training-hub.appspot.com",
    messagingSenderId: "927072446139",
    appId: "1:927072446139:web:721de952b0e0b7aa19ab9e",
    measurementId: "G-34BBV99KXB"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // === DOM Elements ===
  const loginDiv = document.getElementById('login');
  const loginBtn = document.getElementById('loginBtn');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginMessage = document.getElementById('loginMessage');

  const map = document.getElementById('map');
  const game = document.getElementById('game');
  const mapGrid = document.getElementById('mapGrid');
  const gameBoard = document.getElementById('gameBoard');
  const levelTitle = document.getElementById('levelTitle');
  const backToMap = document.getElementById('backToMap');
  const messageDisplay = document.getElementById('message');

  // === Game Variables ===
  const levels = ["üê£","üå≥","üè†","üèñÔ∏è","üèîÔ∏è","üåã","üè∞","üöÄ","üåï"];
  let unlockedLevel = 0;
  let currentLevel = 0;
  const rows = 8, cols = 8;
  const animals = ["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº"];
  let board = [];
  let selected = [];

  const positions = [
    [170, 420],[80, 340],[230, 300],[140, 220],[250, 160],
    [120, 100],[220, 60],[160, 30],[80, 10]
  ];

  // === Firebase Auth ===
  auth.onAuthStateChanged(user => {
    if (user) {
      loadProgress(user.uid);
    } else {
      loginDiv.style.display = 'flex';
      map.style.display = 'none';
      game.style.display = 'none';
    }
  });

  loginBtn.onclick = () => {
    const email = emailInput.value;
    const password = passwordInput.value;
    auth.signInWithEmailAndPassword(email, password)
      .then(({user}) => { loginDiv.style.display='none'; loadProgress(user.uid); })
      .catch(() => {
        // If user not found, create account
        auth.createUserWithEmailAndPassword(email, password)
          .then(({user}) => { loginDiv.style.display='none'; loadProgress(user.uid); })
          .catch(err => loginMessage.textContent = err.message);
      });
  };

  function saveProgress(uid) {
    db.collection('progress').doc(uid).set({ unlockedLevel });
  }

  function loadProgress(uid) {
    db.collection('progress').doc(uid).get().then(doc => {
      if (doc.exists) unlockedLevel = doc.data().unlockedLevel || 0;
      showMap();
    });
  }

  // === Map ===
  function showMap() {
    game.style.display = 'none';
    map.style.display = 'flex';
    mapGrid.innerHTML = '';
    levels.forEach((emoji,i)=>{
      const tile = document.createElement('div');
      tile.className='level-tile';
      tile.textContent=emoji;
      tile.style.left = positions[i][0] + 'px';
      tile.style.top = positions[i][1] + 'px';
      if(i>unlockedLevel) tile.classList.add('locked');
      else { tile.classList.add('unlocked'); tile.onclick=()=>startLevel(i); }
      mapGrid.appendChild(tile);
    });
  }

  // === Game ===
  function startLevel(i) {
    currentLevel = i;
    map.style.display='none';
    game.style.display='flex';
    levelTitle.textContent = `Level ${i+1} ${levels[i]}`;
    initBoard();
  }

  backToMap.onclick = () => { showMap(); saveProgress(auth.currentUser.uid); };

  function initBoard() {
    gameBoard.innerHTML='';
    board=[];
    for(let r=0;r<rows;r++){
      board[r]=[];
      for(let c=0;c<cols;c++){
        const emoji = animals[Math.floor(Math.random()*animals.length)];
        board[r][c]=emoji;
        renderTile(r,c,emoji);
      }
    }
  }

  function renderTile(r,c,emoji){
    const tile=document.createElement('div');
    tile.className='tile';
    tile.textContent=emoji;
    tile.dataset.row=r;
    tile.dataset.col=c;
    tile.onclick=()=>handleClick(r,c);
    gameBoard.appendChild(tile);
  }

  function handleClick(r,c){
    const tile=document.querySelector(`.tile[data-row="${r}"][data-col="${c}"]`);
    if(!tile) return;
    if(tile.classList.contains('selected')){
      tile.classList.remove('selected');
      selected = selected.filter(s=>!(s.r===r && s.c===c));
      return;
    }
    tile.classList.add('selected');
    selected.push({r,c});
    if(selected.length===2){
      swapTiles(selected[0],selected[1]);
      selected.forEach(s=>{
        const t=document.querySelector(`.tile[data-row="${s.r}"][data-col="${s.c}"]`);
        if(t) t.classList.remove('selected');
      });
      selected=[];
    }
  }

  function swapTiles(a,b){
    const temp=board[a.r][a.c];
    board[a.r][a.c]=board[b.r][b.c];
    board[b.r][b.c]=temp;
    updateBoard();
    setTimeout(checkLevelComplete,1000);
  }

  function updateBoard(){
    document.querySelectorAll('.tile').forEach(tile=>{
      const r=+tile.dataset.row;
      const c=+tile.dataset.col;
      tile.textContent=board[r][c];
    });
  }

  function checkLevelComplete(){
    if(Math.random()<0.3){ // Demo win
      alert(`üéâ Level ${currentLevel+1} Complete!`);
      if(currentLevel===unlockedLevel && unlockedLevel<levels.length-1){
        unlockedLevel++;
        saveProgress(auth.currentUser.uid);
      }
      showMap();
    }
  }
</script>
</body>
</html>
