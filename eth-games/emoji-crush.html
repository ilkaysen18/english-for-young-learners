<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emoji Crush Adventure</title>
<style>
  body { font-family: "Segoe UI Emoji", sans-serif; margin:0; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; background:linear-gradient(to bottom, #f0f8ff, #cce7ff);}
  #login, #map, #game { display:none; flex-direction:column; align-items:center; gap:20px; width:100%; max-width:500px;}
  h1,h2 { margin:0; text-align:center; }
  input { padding:10px; font-size:16px; width:80%; }
  button { padding:10px 20px; border:none; background:#4caf50; color:white; border-radius:8px; cursor:pointer; font-size:16px; }
  button:hover{ background:#45a049; }

  /* Map */
  #map .map-area { position:relative; width:400px; height:500px; }
  .level-tile { font-size:36px; cursor:pointer; background:white; border-radius:50%; width:60px; height:60px; text-align:center; line-height:60px; position:absolute; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition:transform 0.3s, opacity 0.3s;}
  .level-tile:hover:not(.locked){transform:scale(1.15);}
  .locked{opacity:0.3; cursor:not-allowed;}
  .unlocked{animation:bounce 1s infinite alternate; box-shadow:0 0 15px #ffd700;}
  @keyframes bounce{from{transform:translateY(0);}to{transform:translateY(-5px);}}

  /* Game board */
  #gameBoard { display:grid; grid-template-columns:repeat(8,60px); grid-template-rows:repeat(8,60px); gap:5px; }
  .tile { display:flex; justify-content:center; align-items:center; font-size:30px; border-radius:10px; background:white; cursor:pointer; transition:transform 0.3s, background 0.3s; user-select:none; }
  .tile.selected { background:#a3f7a3; border:2px solid #2ecc71; }
</style>
</head>
<body>

<!-- Login Screen -->
<div id="login">
  <h1>Login / Signup</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Signup</button>
</div>

<!-- Map Screen -->
<div id="map">
  <h1>üåç Emoji Adventure Map</h1>
  <div class="map-area">
    <svg id="mapPaths"></svg>
    <div id="mapGrid"></div>
  </div>
</div>

<!-- Game Screen -->
<div id="game">
  <h2 id="levelTitle">Level</h2>
  <div id="status">Score: 0 | Level: 1 | Target: 100</div>
  <div id="gameBoard"></div>
  <button id="backToMap">üè† Back to Map</button>
  <div id="message"></div>
</div>

<script type="module">
// --- Firebase setup ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBx4To2-DIglfgq_eHve3bYXYKdsZ0sgEo",
  authDomain: "english-training-hub.firebaseapp.com",
  projectId: "english-training-hub",
  storageBucket: "english-training-hub.firebasestorage.app",
  messagingSenderId: "927072446139",
  appId: "1:927072446139:web:721de952b0e0b7aa19ab9e",
  measurementId: "G-34BBV99KXB"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

// --- UI Elements ---
const loginScreen = document.getElementById('login');
const mapScreen = document.getElementById('map');
const gameScreen = document.getElementById('game');
const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const mapGrid = document.getElementById('mapGrid');
const mapPaths = document.getElementById('mapPaths');
const levelTitle = document.getElementById('levelTitle');
const gameBoard = document.getElementById('gameBoard');
const backToMap = document.getElementById('backToMap');
const statusDisplay = document.getElementById('status');
const messageDisplay = document.getElementById('message');

// --- Game variables ---
const levels = ["üê£","üå≥","üè†","üèñÔ∏è","üèîÔ∏è","üåã","üè∞","üöÄ","üåï"];
const positions = [[170,420],[80,340],[230,300],[140,220],[250,160],[120,100],[220,60],[160,30],[80,10]];
let currentUser = null;
let unlockedLevel = 0;
let currentLevel = 0;

// Emoji Crush board variables
const rows = 8, cols = 8;
const animals = ["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº"];
let board = [];
let selectedTiles = [];
let score = 0;
const baseTarget = 100;

// --- Auth handlers ---
signupBtn.onclick = async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try { await createUserWithEmailAndPassword(auth,email,password); alert("Signup success!"); }
  catch(e){ alert(e.message); }
};
loginBtn.onclick = async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(e){ alert(e.message); }
};

// --- Auth state ---
onAuthStateChanged(auth, async user => {
  if(user){
    currentUser=user;
    // load unlocked level
    const docRef = doc(db,"users",user.uid);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){ unlockedLevel = docSnap.data().unlockedLevel || 0; }
    else{ await setDoc(docRef,{unlockedLevel:0}); unlockedLevel=0; }
    loginScreen.style.display="none";
    showMap();
  } else {
    loginScreen.style.display="flex";
    mapScreen.style.display="none";
    gameScreen.style.display="none";
  }
});

// --- Show map ---
function showMap(){
  gameScreen.style.display="none";
  mapScreen.style.display="flex";
  mapGrid.innerHTML='';
  mapPaths.innerHTML='';
  levels.forEach((emoji,i)=>{
    const tile = document.createElement('div');
    tile.className='level-tile';
    tile.textContent=emoji;
    tile.style.left=positions[i][0]+'px';
    tile.style.top=positions[i][1]+'px';
    if(i>unlockedLevel){ tile.classList.add('locked'); }
    else{ tile.classList.add('unlocked'); tile.onclick=()=>startLevel(i); }
    mapGrid.appendChild(tile);
    if(i>0){
      const [x1,y1]=positions[i-1];
      const [x2,y2]=positions[i];
      const midX=(x1+x2)/2+(Math.random()*40-20);
      const midY=(y1+y2)/2+(Math.random()*40-20);
      const path=document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d",`M${x1+30},${y1+30} Q${midX+30},${midY+30} ${x2+30},${y2+30}`);
      path.setAttribute("stroke","gold"); path.setAttribute("stroke-width","4"); path.setAttribute("fill","none");
      mapPaths.appendChild(path);
    }
  });
}

// --- Start level ---
function startLevel(i){
  currentLevel=i;
  score=0;
  mapScreen.style.display="none";
  gameScreen.style.display="flex";
  levelTitle.textContent=`Level ${i+1} ${levels[i]}`;
  updateStatus();
  initBoard();
}

// --- Back to map ---
backToMap.onclick=showMap;

// --- Init board ---
function initBoard(){
  gameBoard.innerHTML='';
  board=[];
  selectedTiles=[];
  for(let r=0;r<rows;r++){
    board[r]=[];
    for(let c=0;c<cols;c++){
      const emoji=animals[Math.floor(Math.random()*animals.length)];
      board[r][c]=emoji;
      renderTile(r,c,emoji);
    }
  }
}

// --- Render tile ---
function renderTile(r,c,emoji){
  const tile=document.createElement('div');
  tile.className='tile';
  tile.textContent=emoji;
  tile.dataset.row=r;
  tile.dataset.col=c;
  tile.onclick=()=>handleClick(r,c);
  gameBoard.appendChild(tile);
}

// --- Tile click handling ---
function handleClick(r,c){
  const tile=document.querySelector(`.tile[data-row="${r}"][data-col="${c}"]`);
  if(!tile) return;

  if(tile.classList.contains('selected')){
    tile.classList.remove('selected');
    selectedTiles=selectedTiles.filter(s=>!(s.r===r&&s.c===c));
    return;
  }

  tile.classList.add('selected');
  selectedTiles.push({r,c,tile,emoji:board[r][c]});

  if(selectedTiles.length>=3){
    const line=findMatchLine(selectedTiles);
    if(line){
      const pts=calculatePoints(selectedTiles.length);
      score+=pts;
      messageDisplay.textContent=`Matched ${selectedTiles.length} for +${pts} üéâ`;
      selectedTiles.forEach(s=>{
        board[s.r][s.c]=null;
        s.tile.style.visibility='hidden';
      });
      updateStatus();
      selectedTiles=[];
      setTimeout(fallDown,400);
    }
  }

  if(selectedTiles.length>=7 && !findMatchLine(selectedTiles)){
    selectedTiles.forEach(s=>s.tile.classList.remove('selected'));
    selectedTiles=[];
  }
}

// --- Matching logic ---
function findMatchLine(sel){
  if(sel.length<3) return null;
  const e=sel[0].emoji;
  if(!sel.every(s=>s.emoji===e)) return null;

  const rs=sel.map(s=>s.r), cs=sel.map(s=>s.c);
  const dr=rs[1]-rs[0], dc=cs[1]-cs[0];
  const straight=sel.every((s,i,arr)=>i===0||(s.r-arr[i-1].r===dr && s.c-arr[i-1].c===dc));
  if(straight) return 'line';

  const minR=Math.min(...rs), maxR=Math.max(...rs);
  const minC=Math.min(...cs), maxC=Math.max(...cs);
  if(maxR-minR<=1 && maxC-minC<=1) return 'block';

  return null;
}

// --- Points ---
function calculatePoints(n){
  if(n===3) return 10;
  if(n===4) return 20;
  if(n===5) return 35;
  return 35+(n-5)*20;
}

// --- Update board ---
function updateBoard(){
  const tiles=document.querySelectorAll('.tile');
  tiles.forEach(tile=>{
    const r=+tile.dataset.row, c=+tile.dataset.col;
    tile.textContent=board[r][c];
    if(board[r][c]!==null) tile.style.visibility='visible';
  });
}

// --- Fall down ---
function fallDown(){
  const fallingTiles=[];
  for(let c=0;c<cols;c++){
    let empty=0;
    for(let r=rows-1;r>=0;r--){
      if(board[r][c]===null) empty++;
      else if(empty>0){
        board[r+empty][c]=board[r][c];
        board[r][c]=null;
        fallingTiles.push({from:r,to:r+empty,c});
      }
    }
    for(let r=0;r<empty;r++){
      board[r][c]=animals[Math.floor(Math.random()*animals.length)];
      fallingTiles.push({from:-1,to:r,c,newTile:true});
    }
  }
  animateFall(fallingTiles);
}

function animateFall(fallingTiles){
  const tiles=Array.from(document.querySelectorAll('.tile'));
  fallingTiles.forEach(f=>{
    const tile=tiles.find(t=>+t.dataset.row===f.to && +t.dataset.col===f.c);
    if(!tile) return;

    if(f.newTile){
      tile.textContent=board[f.to][f.c];
      tile.style.transform='translateY(-150%)';
      tile.style.opacity=0;
      setTimeout(()=>{ tile.style.transition='transform 0.4s ease, opacity 0.4s ease'; tile.style.transform='translateY(0)'; tile.style.opacity=1; },50);
    } else {
      const distance=(f.to-f.from)*tile.offsetHeight;
      tile.style.transition='transform 0.4s ease';
      tile.style.transform=`translateY(${distance}px)`;
      setTimeout(()=>{
        tile.style.transition=''; tile.style.transform='';
        renderTile(f.to,f.c,board[f.to][f.c]);
      },400);
    }
  });
  setTimeout(checkLevelComplete,500);
}

// --- Status ---
function updateStatus(){ statusDisplay.textContent=`Score: ${score} | Level: ${currentLevel+1} | Target: ${baseTarget}`; }

// --- Check level complete ---
async function checkLevelComplete(){
  // Fake win for demo; you can implement real match checks
  if(Math.random()<0.3){
    alert(`üéâ Level ${currentLevel+1} Complete!`);
    if(currentLevel===unlockedLevel && unlockedLevel<levels.length-1) unlockedLevel++;
    // Save progress in Firebase
    await setDoc(doc(db,"users",currentUser.uid),{unlockedLevel},{merge:true});
    showMap();
  }
}

</script>
</body>
</html>
