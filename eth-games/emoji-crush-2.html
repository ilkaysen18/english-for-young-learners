<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"/>
<title>Emoji Crush Adventure ‚Äî Login + Map + Levels</title>

<!-- Leaflet (OpenStreetMap) for embedded map (no API key) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root { --panel-w: 980px; }
  html,body { height:100%; margin:0; font-family: "Segoe UI", Tahoma, sans-serif; background: linear-gradient(135deg,#fefcea,#f1da36); -webkit-font-smoothing:antialiased; }
  .wrapper { width:100%; min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:28px; box-sizing:border-box; }
  .panel { width:var(--panel-w); max-width:calc(100% - 48px); background:rgba(255,255,255,0.98); border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.12); padding:16px; }
  header h1 { margin:6px 0 4px; font-size: clamp(22px, 3.6vw, 32px); color:#ff6600; font-family:'Fredoka One',cursive; text-shadow:1px 1px 2px #999; }
  header h3 { margin:0; color:#0066cc; font-weight:600; }
  .row { display:flex; gap:12px; align-items:center; margin:8px 0; }
  .center { justify-content:center; }

  /* login */
  #loginBox { display:flex; flex-direction:column; gap:8px; align-items:center; padding:10px; }
  input { width:320px; max-width:90%; padding:10px 12px; border-radius:8px; border:1px solid #d0d7de; font-size:15px; }
  button { padding:10px 14px; border-radius:9px; border:0; background:#1f8a3d; color:#fff; font-weight:700; cursor:pointer; }
  button.secondary{ background:#2b6fa4; }
  button.ghost{ background:transparent; color:#1f8a3d; border:1px solid #1f8a3d; }
  .muted { color:#666; font-size:13px; }

  /* map screen */
  #mapScreen { display:none; flex-direction:column; gap:12px; }
  .map-area { position:relative; width:100%; height:420px; border-radius:10px; overflow:hidden; background:#eef; }
  #levelGrid { position:absolute; inset:0; pointer-events:auto; }
  .level-tile { position:absolute; width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#fff; font-size:28px; box-shadow:0 8px 20px rgba(0,0,0,0.12); cursor:pointer; transition:transform .18s, opacity .18s; }
  .level-tile.locked{ opacity:.35; filter:grayscale(0.4); cursor:default; }
  .level-tile.unlocked{ box-shadow:0 0 18px #ffd76a; transform-origin:center; }
  #miniMap { position:absolute; right:8px; top:8px; width:220px; height:140px; border-radius:8px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,0.12); border:3px solid rgba(255,255,255,0.6); }

  /* game screen */
  #gameScreen { display:none; flex-direction:column; gap:10px; align-items:center; }
  #status { font-size:16px; font-weight:700; color:#333; }
  #gameContainer { width:100%; display:flex; justify-content:center; align-items:center; }
  #gameBoard { display:grid; grid-template-columns: repeat(12, 1fr); aspect-ratio: 12 / 16; width:95%; max-width:920px; grid-gap:0.6vw; }
  .tile { background:#fff; border-radius:0.6vw; display:flex; align-items:center; justify-content:center; font-size:clamp(18px,3.8vw,36px); cursor:pointer; user-select:none; transition:transform .18s, background .18s, opacity .25s; }
  .tile.selected{ background:#b8ffba; transform:scale(1.12); box-shadow:0 0 10px #6f6; }
  #message { min-height:28px; font-weight:700; color:#166534; }
  .controls { display:flex; gap:8px; align-items:center; justify-content:center; margin-top:8px; }

  /* responsive */
  @media (max-width:720px){ :root{ --panel-w: 96vw; } .level-tile{ width:54px;height:54px;font-size:24px; } #miniMap{ display:none;} }
</style>
</head>
<body>
<div class="wrapper">
  <div class="panel">
    <header style="text-align:center;">
      <h3>English Training Hub</h3>
      <h1>Emoji Crush üéâ</h1>
      <div style="color:#333;font-weight:600;margin-top:4px;">üêæ Match 3+ Animal Emojis!</div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen">
      <div id="loginBox">
        <input id="email" type="email" placeholder="Email (or leave for Google sign-in)"/>
        <input id="password" type="password" placeholder="Password (for email signup/login)"/>
        <div class="row center">
          <button id="emailSignBtn">Login / Signup (email)</button>
          <button id="googleSignBtn" class="secondary">Sign in with Google</button>
        </div>
        <div id="loginMsg" class="muted">You can sign up with email or use Google sign-in.</div>
      </div>
    </div>

    <!-- MAP SCREEN -->
    <div id="mapScreen">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <div id="welcome" style="font-weight:700;color:#0b5;">Welcome</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="logoutBtn" class="ghost">Logout</button>
        </div>
      </div>

      <div class="map-area" id="mapArea">
        <svg id="mapPaths" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;">
          <defs>
            <linearGradient id="gold" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#ffa500"/>
            </linearGradient>
          </defs>
        </svg>
        <div id="levelGrid"></div>
        <div id="miniMap"></div>
      </div>
      <div class="controls">
        <div id="mapMsg" class="muted"></div>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen">
      <div id="status">Score: 0 | Level: 1 | Target: 100</div>
      <div id="gameContainer"><div id="gameBoard"></div></div>
      <div id="message"></div>
      <div class="controls">
        <button id="restartBtn">Restart Level</button>
        <button id="backToMapBtn">üè† Back to Map</button>
      </div>
    </div>

  </div>
</div>

<!-- Firebase compat (works on GitHub Pages without module issues) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ========== CONFIG ========== */
const firebaseConfig = {
  apiKey: "AIzaSyBx4To2-DIglfgq_eHve3bYXYKdsZ0sgEo",
  authDomain: "english-training-hub.firebaseapp.com",
  projectId: "english-training-hub",
  storageBucket: "english-training-hub.firebasestorage.app",
  messagingSenderId: "927072446139",
  appId: "1:927072446139:web:721de952b0e0b7aa19ab9e",
  measurementId: "G-34BBV99KXB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ========== UI refs ========== */
const loginScreen = document.getElementById('loginScreen');
const mapScreen = document.getElementById('mapScreen');
const gameScreen = document.getElementById('gameScreen');
const loginMsg = document.getElementById('loginMsg');
const welcomeEl = document.getElementById('welcome');
const levelGrid = document.getElementById('levelGrid');
const mapPaths = document.getElementById('mapPaths');
const miniMapEl = document.getElementById('miniMap');

const emailSignBtn = document.getElementById('emailSignBtn');
const googleSignBtn = document.getElementById('googleSignBtn');
const logoutBtn = document.getElementById('logoutBtn');

const backToMapBtn = document.getElementById('backToMapBtn');
const restartBtn = document.getElementById('restartBtn');

const statusDisplay = document.getElementById('status');
const gameBoard = document.getElementById('gameBoard');
const messageDisplay = document.getElementById('message');
const mapMsg = document.getElementById('mapMsg');

/* ========== Game & map data ========== */
const levels = ["üê£","üå≥","üè†","üèñÔ∏è","üèîÔ∏è","üåã","üè∞","üöÄ","üåï"];
const positions = [
  [170,420],[80,340],[230,300],[140,220],[250,160],[120,100],[220,60],[160,30],[80,10]
];
const rows = 16, cols = 12;
const animals = ['üêº','üê∏','üê∑','ü¶ò','üêí'];
const baseTarget = 100;

/* game state */
let user = null;
let unlockedLevel = 0;
let currentLevel = 0;
let board = [];
let selected = [];
let score = 0;
let levelNum = 1;

/* ========== Map (Leaflet) ========== */
let miniMap;
function initMiniMap(){
  try{
    miniMap = L.map(miniMapEl, { attributionControl:false, zoomControl:false }).setView([41.01, 28.97], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(miniMap);
  }catch(e){ /* ignore if leaflet not ready */ }
}

/* ========== Auth actions ========== */
emailSignBtn.onclick = async () => {
  const mail = document.getElementById('email').value || prompt('Email for demo signup/login (enter):') || '';
  const pass = document.getElementById('password') ? document.getElementById('password').value : (prompt('Password:')||'');
  if(!mail || !pass){ loginMsg.textContent='Please provide email & password.'; return; }
  loginMsg.textContent = 'Signing in...';
  try{
    await auth.signInWithEmailAndPassword(mail, pass);
    loginMsg.textContent = '';
  } catch(e){
    // if sign-in fails, try signup
    try{
      await auth.createUserWithEmailAndPassword(mail, pass);
      loginMsg.textContent = 'Account created ‚Äî signed in.';
    }catch(err){
      loginMsg.textContent = 'Auth error: ' + err.message;
    }
  }
};

googleSignBtn.onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    await auth.signInWithPopup(provider);
    loginMsg.textContent = '';
  }catch(e){ loginMsg.textContent = 'Google sign-in failed: ' + e.message; }
};

logoutBtn.onclick = async () => {
  await auth.signOut();
};

/* ========== Auth state handler ========== */
auth.onAuthStateChanged(async u => {
  user = u;
  if(user){
    // load progress
    try{
      const snap = await db.collection('progress').doc(user.uid).get();
      unlockedLevel = snap.exists && snap.data().unlockedLevel !== undefined ? snap.data().unlockedLevel : 0;
    }catch(e){ unlockedLevel = 0; }
    welcomeEl.textContent = `Welcome, ${user.displayName || user.email || 'Player'}`;
    showMapScreen();
  } else {
    showLogin();
  }
});

/* ========== Show screens helpers ========== */
function showLogin(){
  loginScreen.style.display = 'block';
  mapScreen.style.display = 'none';
  gameScreen.style.display = 'none';
  // create simple email/password inputs inside login screen if not present
  if(!document.getElementById('email')){
    const inputEmail = document.createElement('input'); inputEmail.id='email'; inputEmail.placeholder='Email';
    const inputPass = document.createElement('input'); inputPass.id='password'; inputPass.placeholder='Password';
    inputPass.type='password';
    const loginBox = document.getElementById('loginBox') || document.createElement('div');
    if(!document.getElementById('loginBox')){ loginBox.id='loginBox'; document.querySelector('#loginScreen').appendChild(loginBox); }
    loginBox.prepend(inputPass); loginBox.prepend(inputEmail);
  }
}

function showMapScreen(){
  loginScreen.style.display = 'none';
  mapScreen.style.display = 'flex';
  gameScreen.style.display = 'none';
  renderMap();
  // init mini map if not already
  if(!miniMap) initMiniMap();
}

/* ========== Map rendering (level tiles + paths) ========== */
function renderMap(){
  levelGrid.innerHTML = '';
  mapPaths.innerHTML = `
    <defs>
      <linearGradient id="gold" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#ffa500"/></linearGradient>
    </defs>`;
  for(let i=0;i<levels.length;i++){
    const emoji = levels[i];
    const tile = document.createElement('div');
    tile.className = 'level-tile';
    tile.textContent = emoji;
    tile.style.left = positions[i][0] + 'px';
    tile.style.top = positions[i][1] + 'px';
    tile.style.position = 'absolute';
    if(i > unlockedLevel){
      tile.classList.add('locked');
    } else {
      tile.classList.add('unlocked');
      tile.onclick = () => startLevel(i);
    }
    levelGrid.appendChild(tile);

    if(i>0){
      const [x1,y1] = positions[i-1];
      const [x2,y2] = positions[i];
      const midX = (x1+x2)/2 + (Math.random()*40-20);
      const midY = (y1+y2)/2 + (Math.random()*40-20);
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", `M${x1+30},${y1+30} Q${midX+30},${midY+30} ${x2+30},${y2+30}`);
      mapPaths.appendChild(path);
    }
  }
  mapMsg.textContent = `Unlocked: ${unlockedLevel+1}/${levels.length} levels`;
}

/* ========== Start Level ========== */
function startLevel(index){
  currentLevel = index;
  levelNum = index + 1;
  score = 0;
  selected = [];
  showGameScreen();
  initBoard();
}

/* ========== Show game screen ========== */
function showGameScreen(){
  loginScreen.style.display = 'none';
  mapScreen.style.display = 'none';
  gameScreen.style.display = 'flex';
  messageDisplay.textContent = '';
}

/* ========== Game core (based on your provided code) ========== */

/* sounds (simple) */
const audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
function playTone(f, d=0.12){ if(!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=f; g.gain.value=0.12; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); }
function successSound(){ [440,660,880].forEach((f,i)=>setTimeout(()=>playTone(f),i*120)); }
function victorySound(){ [523,659,784].forEach((f,i)=>setTimeout(()=>playTone(f,0.18),i*160)); }
function failSound(){ [200,160].forEach((f,i)=>setTimeout(()=>playTone(f,0.18),i*200)); }

function initBoard(){
  board = [];
  for(let r=0;r<rows;r++){
    const row=[];
    for(let c=0;c<cols;c++){
      row.push(animals[Math.floor(Math.random()*animals.length)]);
    }
    board.push(row);
  }
  ensurePlayableBoard();
  renderBoard();
  updateStatus();
}

function renderBoard(){
  gameBoard.innerHTML = '';
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.textContent = board[r][c];
      tile.dataset.row = r; tile.dataset.col = c;
      tile.addEventListener('click', tileClick);
      gameBoard.appendChild(tile);
    }
  }
}

function renderTile(r,c,emoji){
  const index = r*cols + c;
  const tile = gameBoard.children[index];
  if(!tile) return;
  tile.textContent = emoji;
  tile.style.visibility = 'visible';
  tile.classList.remove('selected');
  tile.dataset.row = r; tile.dataset.col = c;
  tile.removeEventListener('click', tileClick);
  tile.addEventListener('click', tileClick);
}

function findMatchLine(sel){
  if(sel.length < 3) return null;
  const e = sel[0].emoji;
  if(!sel.every(s=>s.emoji===e)) return null;
  const rs = sel.map(s=>s.r);
  const cs = sel.map(s=>s.c);
  const dr = rs[1]-rs[0], dc = cs[1]-cs[0];
  const straight = sel.every((s,i,arr) => i===0 || (s.r - arr[i-1].r === dr && s.c - arr[i-1].c === dc));
  if(straight) return 'line';
  const minR=Math.min(...rs), maxR=Math.max(...rs), minC=Math.min(...cs), maxC=Math.max(...cs);
  if((maxR-minR<=1)&&(maxC-minC<=1)) return 'block';
  const sameSlope = Math.abs((rs[rs.length-1]-rs[0])/(cs[cs.length-1]-cs[0]||1))===1;
  if(sameSlope) return 'diagonal';
  return null;
}

function calculatePoints(n){
  if(n===3) return 10;
  if(n===4) return 20;
  if(n===5) return 35;
  return 35 + (n-5)*20;
}

function tileClick(e){
  const tile = e.currentTarget;
  const r = +tile.dataset.row, c = +tile.dataset.col;
  // toggle unselect
  if(tile.classList.contains('selected')){
    tile.classList.remove('selected');
    selected = selected.filter(s => !(s.r===r && s.c===c));
    return;
  }
  tile.classList.add('selected');
  selected.push({ r, c, emoji: board[r][c], tile });
  // check match
  if(selected.length >= 3){
    const dir = findMatchLine(selected);
    if(dir){
      clearTimeout(window.matchTimeout);
      window.matchTimeout = setTimeout(() => {
        const pts = calculatePoints(selected.length);
        successSound();
        score += pts;
        messageDisplay.textContent = `Matched ${selected.length} for +${pts} üéâ`;
        // remove highlight and hide
        selected.forEach(s => {
          s.tile.classList.remove('selected');
          board[s.r][s.c] = null;
          s.tile.style.visibility = 'hidden';
        });
        selected = [];
        updateStatus();
        setTimeout(fallDown, 400);
      }, 350);
    }
  }
  // safety - reset if nonsense
  if(selected.length >= 7 && !findMatchLine(selected)){
    failSound();
    selected.forEach(s=>s.tile.classList.remove('selected'));
    selected = [];
  }
}

function fallDown(){
  const fallingTiles = [];
  for(let c=0;c<cols;c++){
    let empty = 0;
    for(let r=rows-1;r>=0;r--){
      if(board[r][c] === null) empty++;
      else if(empty>0){
        board[r+empty][c] = board[r][c];
        board[r][c] = null;
        fallingTiles.push({ from:r, to:r+empty, c });
      }
    }
    for(let r=0;r<empty;r++){
      board[r][c] = animals[Math.floor(Math.random()*animals.length)];
      fallingTiles.push({ from:-1, to:r, c, newTile:true });
    }
  }
  animateFall(fallingTiles);
}

function animateFall(fallingTiles){
  const tiles = Array.from(gameBoard.querySelectorAll('.tile'));
  fallingTiles.forEach(f=>{
    const tile = tiles.find(t => +t.dataset.row === f.to && +t.dataset.col === f.c);
    if(!tile) return;
    if(f.newTile){
      tile.textContent = board[f.to][f.c];
      tile.style.transform = 'translateY(-150%)';
      tile.style.opacity = 0;
      setTimeout(()=>{ tile.style.transition='transform .36s ease, opacity .36s ease'; tile.style.transform='translateY(0)'; tile.style.opacity=1; }, 50);
    } else {
      const distance = (f.to - f.from) * tile.offsetHeight;
      tile.style.transition = 'transform .36s ease';
      tile.style.transform = `translateY(${distance}px)`;
      setTimeout(()=>{ tile.style.transition=''; tile.style.transform=''; renderTile(f.to, f.c, board[f.to][f.c]); }, 380);
    }
  });
  setTimeout(()=>{ autoShuffleIfNoMoves(); checkLevelComplete(); }, 500);
}

function hasPossibleMoves(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const e = board[r][c];
      if(e==null) continue;
      if(c+2<cols && board[r][c+1]===e && board[r][c+2]===e) return true;
      if(r+2<rows && board[r+1][c]===e && board[r+2][c]===e) return true;
    }
  }
  return false;
}

function shuffleBoard(){
  const flat = board.flat();
  for(let i=flat.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [flat[i],flat[j]]=[flat[j],flat[i]];
  }
  board=[];
  for(let r=0;r<rows;r++) board.push(flat.slice(r*cols,(r+1)*cols));
}

function ensurePlayableBoard(){
  let safety=0;
  while(!hasPossibleMoves() && safety<200){
    shuffleBoard();
    safety++;
  }
}

function autoShuffleIfNoMoves(){
  if(!hasPossibleMoves()){
    messageDisplay.textContent = 'üîÑ No matches ‚Äî shuffling...';
    shuffleBoard();
    ensurePlayableBoard();
    setTimeout(()=>{ renderBoard(); messageDisplay.textContent=''; }, 380);
  }
}

function checkLevelComplete(){
  const target = baseTarget * levelNum;
  if(score >= target){
    victorySound();
    messageDisplay.textContent = `üéâ You cleared Level ${levelNum}!`;
    // unlock next level persistently
    if(currentLevel === unlockedLevel && unlockedLevel < levels.length - 1){
      unlockedLevel++;
      if(user){
        db.collection('progress').doc(user.uid).set({ unlockedLevel }).catch(()=>{/*ignore*/});
      }
    }
    // back to map after small delay
    setTimeout(()=>{ showMapScreen(); }, 900);
  }
}

function updateStatus(){
  statusDisplay.textContent = `Score: ${score} | Level: ${levelNum} | Target: ${baseTarget * levelNum}`;
}

/* restart/back handlers */
backToMapBtn.onclick = showMapScreen;
restartBtn.onclick = ()=>{ score=0; selected=[]; initBoard(); messageDisplay.textContent=''; };

/* initialize small UI */
showLogin();

/* End of script */
</script>
</body>
  </html>
