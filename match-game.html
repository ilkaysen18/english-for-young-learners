<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animal Emoji Match‚Äë3 Game (6√ó9)</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg, #fefcea, #f1da36);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
    text-align: center;
  }
  h1 { color: #444; margin-bottom: 5px; }
  #status {
    font-size: 17px;
    font-weight: bold;
    margin: 6px 0;
  }
  #gameBoard {
    display: grid;
    grid-template-columns: repeat(6, 60px);
    grid-gap: 6px;
    margin-top: 15px;
    position: relative;
  }
  .tile {
    width: 60px;
    height: 60px;
    background: #fff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    cursor: pointer;
    transition: transform 0.2s, background 0.25s;
  }
  .tile.selected { background: #b8ffba; transform: scale(1.1); }
  #message { font-size: 18px; font-weight: bold; margin-top: 12px; color: #3b7a00; min-height: 30px; }
  button {
    margin-top: 15px;
    background: #4caf50;
    color: white;
    border: none;
    padding: 10px 18px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #45a049; }

  @keyframes fall {
    from { transform: translateY(-80px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @media (max-width: 480px) {
    #gameBoard { grid-template-columns: repeat(6, 50px); }
    .tile { width: 50px; height: 50px; font-size: 26px; }
  }
</style>
</head>
<body>
<h1>üêæ Match 3 Animal Emojis!</h1>
<div id="status">Score: 0 | Level: 1 | Target: 100</div>
<div id="gameBoard"></div>
<div id="message"></div>
<button id="restart">Restart</button>

<script>
  const rows = 9;   // 9 rows
  const cols = 6;   // 6 columns
  const animals = ['üê∂','üê±','üê∞','üêª','ü¶ä','üêº','üê∏','ü¶Å','üê∑'];
  let board = [];
  let selected = [];
  let score = 0;
  let level = 1;
  const baseTarget = 100;

  const gameBoard = document.getElementById('gameBoard');
  const statusDisplay = document.getElementById('status');
  const messageDisplay = document.getElementById('message');

  // === SOUND SYSTEM ===
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playTone(freq, dur=0.15, type='sine', vol=0.2){
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.value = vol;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
  }
  function successSound(){
    [440, 660, 880].forEach((f,i)=>setTimeout(()=>playTone(f,0.15), i*150));
  }
  function failSound(){
    [200,150].forEach((f,i)=>setTimeout(()=>playTone(f,0.2,'square'), i*250));
  }
  function victorySound(){
    [523,659,784,1046].forEach((f,i)=>setTimeout(()=>playTone(f,0.2,'triangle',0.25), i*200));
  }
  function shuffleSound(){
    [220,330,440].forEach((f,i)=>setTimeout(()=>playTone(f,0.1,'sine',0.15), i*120));
  }

  // === GAME INITIALIZATION ===
  function initBoard(){
    do {
      board = [];
      for(let r=0;r<rows;r++){
        const row = [];
        for(let c=0;c<cols;c++){
          const emoji = animals[Math.floor(Math.random()*animals.length)];
          row.push(emoji);
        }
        board.push(row);
      }
    } while (!hasPossibleMoves()); // ensure at least one possible match exists

    renderBoard();
    updateStatus();
    messageDisplay.textContent = '';
  }

  function renderBoard(){
    gameBoard.innerHTML = '';
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.textContent = board[r][c];
        tile.dataset.row = r;
        tile.dataset.col = c;
        tile.addEventListener('click', tileClick);
        gameBoard.appendChild(tile);
      }
    }
  }

  function isThreeInLine(sel){
    if(sel.length !== 3) return false;
    const [a,b,c] = sel;

    // Must have all same emoji
    if(!(a.emoji === b.emoji && b.emoji === c.emoji)) return false;

    // Check for same row or same column and adjacent sequence
    const rowsSet = [a.r,b.r,c.r].sort((x,y)=>x-y);
    const colsSet = [a.c,b.c,c.c].sort((x,y)=>x-y);

    const horizontal = (rowsSet[0] === rowsSet[1] && rowsSet[1] === rowsSet[2]) &&
                       (colsSet[2] - colsSet[0] === 2) &&
                       (colsSet[1] - colsSet[0] === 1);
    const vertical = (colsSet[0] === colsSet[1] && colsSet[1] === colsSet[2]) &&
                     (rowsSet[2] - rowsSet[0] === 2) &&
                     (rowsSet[1] - rowsSet[0] === 1);

    return horizontal || vertical;
  }

  function tileClick(e){
    const tile = e.currentTarget;
    const r = parseInt(tile.dataset.row);
    const c = parseInt(tile.dataset.col);
    if(tile.classList.contains('selected')) return;

    tile.classList.add('selected');
    selected.push({r,c,emoji: board[r][c],tile});

    if(selected.length===3){
      if(isThreeInLine(selected)){
        successSound();
        score += 10;
        selected.forEach(s=>{ s.tile.style.visibility='hidden'; board[s.r][s.c]=null; });
        updateStatus();
        setTimeout(()=>{ fallDown(); }, 400);
      } else {
        failSound();
        selected.forEach(s=>s.tile.classList.remove('selected'));
      }
      selected = [];
    }
  }

  // === CASCADE FALLING ===
  function fallDown(){
    for(let c=0;c<cols;c++){
      let emptyRow = rows-1;
      for(let r=rows-1;r>=0;r--){
        if(board[r][c]!==null){
          board[emptyRow][c]=board[r][c];
          if(emptyRow!==r) board[r][c]=null;
          emptyRow--;
        }
      }
      for(let r=emptyRow;r>=0;r--){
        board[r][c] = animals[Math.floor(Math.random()*animals.length)];
      }
    }
    renderFall();
    checkNoMoves();
    checkLevelComplete();
  }

  function renderFall(){
    gameBoard.innerHTML = '';
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.textContent = board[r][c];
        tile.dataset.row = r;
        tile.dataset.col = c;
        tile.style.animation = 'fall 0.4s ease';
        tile.addEventListener('click', tileClick);
        gameBoard.appendChild(tile);
      }
    }
  }

  // === CHECK LEVEL COMPLETE ===
  function checkLevelComplete(){
    const target = baseTarget * level;
    if(score >= target){
      victorySound();
      messageDisplay.textContent = `üéâ You cleared Level ${level}! ü•≥`;
      const nextBtn = document.createElement('button');
      nextBtn.textContent = `Next Level ‚ñ∂Ô∏è`;
      nextBtn.onclick = ()=>{
        level++;
        messageDisplay.textContent = '';
        initBoard();
      };
      messageDisplay.appendChild(nextBtn);
    }
  }

  // === CHECK FOR POSSIBLE MOVES ===
  function hasPossibleMoves(){
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const emoji = board[r][c];

        // check horizontal triplets containing this cell
        if(c+2<cols && board[r][c+1]===emoji && board[r][c+2]===emoji) return true;
        if(c>0 && c+1<cols && board[r][c-1]===emoji && board[r][c+1]===emoji) return true;
        if(c-2>=0 && board[r][c-1]===emoji && board[r][c-2]===emoji) return true;

        // check vertical triplets
        if(r+2<rows && board[r+1][c]===emoji && board[r+2][c]===emoji) return true;
        if(r>0 && r+1<rows && board[r-1][c]===emoji && board[r+1][c]===emoji) return true;
        if(r-2>=0 && board[r-1][c]===emoji && board[r-2][c]===emoji) return true;
      }
    }
    return false;
  }

  // If there are no moves, shuffle until at least one possible match exists
  function checkNoMoves(){
    if(!hasPossibleMoves()){
      shuffleSound();
      messageDisplay.textContent = 'üîÑ Shuffling ‚Äî no possible matches!';
      shuffleBoard();
      renderFall();
    } else {
      messageDisplay.textContent = '';
    }
  }

  function shuffleBoard(){
    const flat = board.flat();
    // shuffle in place
    for(let i=flat.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [flat[i],flat[j]]=[flat[j],flat[i]];
    }
    // reshape into grid
    board=[];
    for(let r=0;r<rows;r++){
      board.push(flat.slice(r*cols,(r+1)*cols));
    }
    // ensure shuffled board has moves; repeat if not
    if(!hasPossibleMoves()) shuffleBoard();
  }

  function updateStatus(){
    const target = baseTarget * level;
    statusDisplay.textContent = `Score: ${score} | Level: ${level} | Target: ${target}`;
  }

  document.getElementById('restart').addEventListener('click', ()=>{
    score=0; level=1;
    initBoard();
  });

  initBoard();
</script>
</body>
</html>
